<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.8.dev">
<meta name="author" content="Servicio de las Tecnologías de la Información y las Comunicaciones - Universidad de Almería">
<title>Relaciones en NestJS</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
td.tableblock>.content>:last-child.sidebarblock{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Relaciones en NestJS</h1>
<div class="details">
<span id="author" class="author">Servicio de las Tecnologías de la Información y las Comunicaciones - Universidad de Almería</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#trueresumen">Resumen</a></li>
<li><a href="#trueintroducción">1. Introducción</a></li>
<li><a href="#truepreparación-del-entorno">2. Preparación del entorno</a></li>
<li><a href="#truecreación-del-módulo-de-editoriales">3. Creación del módulo de editoriales</a>
<ul class="sectlevel2">
<li><a href="#trueconfiguración-de-la-entidad">3.1. Configuración de la entidad</a></li>
<li><a href="#trueconfiguración-del-módulo">3.2. Configuración del módulo</a></li>
<li><a href="#truecreación-del-dto-de-creación-de-editoriales">3.3. Creación del DTO de creación de editoriales</a></li>
<li><a href="#trueimplementación-de-los-métodos-del-servicio">3.4. Implementación de los métodos del servicio</a></li>
<li><a href="#trueimplementación-del-controlador">3.5. Implementación del controlador</a></li>
<li><a href="#truecomprobación-de-los-endpoints">3.6. Comprobación de los endpoints</a></li>
</ul>
</li>
<li><a href="#truecreación-del-módulo-de-libros">4. Creación del módulo de libros</a>
<ul class="sectlevel2">
<li><a href="#trueconfiguración-de-la-entidad-2">4.1. Configuración de la entidad</a></li>
<li><a href="#trueconfiguración-del-módulo-2">4.2. Configuración del módulo</a></li>
<li><a href="#truecreación-del-dto-de-creación-de-libros">4.3. Creación del DTO de creación de libros</a></li>
<li><a href="#trueimplementación-de-los-métodos-del-servicio-2">4.4. Implementación de los métodos del servicio</a></li>
<li><a href="#trueimplementación-del-controlador-2">4.5. Implementación del controlador</a></li>
<li><a href="#truecomprobación-de-los-endpoints-2">4.6. Comprobación de los endpoints</a></li>
</ul>
</li>
<li><a href="#truecreación-del-módulo-de-comentarios">5. Creación del módulo de comentarios</a>
<ul class="sectlevel2">
<li><a href="#trueconfiguración-de-la-entidad-3">5.1. Configuración de la entidad</a></li>
<li><a href="#trueconfiguración-del-módulo-3">5.2. Configuración del módulo</a></li>
<li><a href="#truecreación-del-dto-de-creación-de-comentarios">5.3. Creación del DTO de creación de comentarios</a></li>
<li><a href="#trueimplementación-de-los-métodos-del-servicio-3">5.4. Implementación de los métodos del servicio</a></li>
<li><a href="#trueimplementación-del-controlador-3">5.5. Implementación del controlador</a></li>
<li><a href="#truecomprobación-de-los-endpoints-3">5.6. Comprobación de los endpoints</a></li>
</ul>
</li>
<li><a href="#truecreación-del-módulo-de-palabras-clave">6. Creación del módulo de palabras clave</a>
<ul class="sectlevel2">
<li><a href="#trueconfiguración-de-la-entidad-4">6.1. Configuración de la entidad</a></li>
<li><a href="#trueconfiguración-del-módulo-4">6.2. Configuración del módulo</a></li>
<li><a href="#truecreación-del-dto-de-creación-de-palabras-clave">6.3. Creación del DTO de creación de palabras clave</a></li>
<li><a href="#trueimplementación-de-los-métodos-del-servicio-4">6.4. Implementación de los métodos del servicio</a></li>
<li><a href="#trueimplementación-del-controlador-4">6.5. Implementación del controlador</a></li>
<li><a href="#truecomprobación-de-los-endpoints-4">6.6. Comprobación de los endpoints</a></li>
</ul>
</li>
<li><a href="#truecreación-de-las-relaciones">7. Creación de las relaciones</a>
<ul class="sectlevel2">
<li><a href="#truecreación-de-la-relación-entre-book-y-publisher">7.1. Creación de la relación entre <code>Book</code> y <code>Publisher</code></a></li>
<li><a href="#truecreación-de-la-relación-entre-book-y-comment">7.2. Creación de la relación entre <code>Book</code> y <code>Comment</code></a></li>
<li><a href="#truecreación-de-la-relación-entre-book-y-keyword">7.3. Creación de la relación entre <code>Book</code> y <code>Keyword</code></a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/logocloudstic.png" alt="logocloudstic">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueresumen"><a class="anchor" href="#trueresumen"></a>Resumen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Las relaciones son asociaciones entre entidades de nuestro dominio. A través de TypeORM, NestJS ofrece la posibilidad de definir relaciones para facilitar la combinación y relación de datos entre las tablas de la base de datos. Al definir las relaciones entre entidades, TypeORM se encargará de definir claves ajenas y tablas de relación para relaciones M:N. En este tutorial veremos cómo tratar en una API NestJS con relaciones 1:M y M:N.</p>
</div>
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>Crear una API REST funcional con NestJS.</p>
</li>
<li>
<p>Introducir el uso de relaciones <code>1:M</code>, <code>M:1</code> y <code>M:N</code> entre entidades.</p>
</li>
<li>
<p>Adaptar los DTO para que puedan tratar con datos relacionados.</p>
</li>
<li>
<p>Programar los servicios de interacción con la base de datos para que devuelvan datos relacionados.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Disponible el <a href="https://github.com/ualmtorres/nestjs-relationships.git">repositorio</a> usado en este tutorial.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueintroducción"><a class="anchor" href="#trueintroducción"></a>1. Introducción</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Las relaciones nos permiten combinar entidades persistentes de nuestro dominio. NestJS utiliza <a href="https://typeorm.io/">TypeORM</a> como framework de persistencia en bases de datos. TypeORM ofrece decoradores para la creación de relaciones entre entidades (<code>1:M</code>, <code>M:1</code> y <code>M:N</code>).</p>
</div>
<div class="paragraph">
<p>En este tutorial crearemos una API REST desde cero comenzando por la creación de las entidades. Posteriormnente, le añadiremos las relaciones de forma paulatina. Usaremos un caso de uso sencillo de libros, que tienen asociados editoriales, comentarios y palabras clave. Este ejemplo servirá como escenario en el que ir aprediendo a tratar con relaciones entre entidades en una API REST en NestJS.</p>
</div>
<div class="paragraph">
<p>A continuación se muestra el diagrama relacional de la base de datos asociada. Como aclaración:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Cada libro puede tener varios comentarios. Cada comentario corresponde a un único libro.</p>
</li>
<li>
<p>Cada libro tiene una editorial. De cada editorial puede haber varios libros.</p>
</li>
<li>
<p>Un libro puede tener varias palabras clave. A cada palabra clave puede haber asociados varios libros.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/ERD.png" alt="ERD"></span></p>
</div>
<div class="paragraph">
<p>Desde el punto de la aplicación, las clases asociadas a este problema van a persitirse como entidades, las cuales serán gestionadas por TypeORM. A continuación se muestra el diagrama de clases asociado.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/class-diagram.png" alt="class diagram"></span></p>
</div>
<div class="paragraph">
<p>En el diagrama de clases se observa que las relaciones son bidireccionales, ya que cada relación tiene un campo en cada extremo de la relación. Esto permitirá a una entidad acceder a sus entidades relacionadas.</p>
</div>
<div class="paragraph">
<p>La <a href="https://typeorm.io/relations">documentación oficial de TypeORM</a> ofrece información de interés sobre las cuestiones tratadas en este tutorial así como otras no incluidas, como ejemplo de propagación de cambios en claves ajenas (<code>RESTRICT, CASCADE, SET NULL</code>) y gestión de huérfanos.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truepreparación-del-entorno"><a class="anchor" href="#truepreparación-del-entorno"></a>2. Preparación del entorno</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Partimos de un proyecto NestJS en blanco en el que instalamos los paquetes para</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JWT y Passport</p>
</li>
<li>
<p>TypeORM y MySQL</p>
</li>
<li>
<p>Swagger</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los instalamos con:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm install --save @nestjs/jwt passport passport-jwt @nestjs/passport
$ npm install --save @nestjs/typeorm typeorm mysql
$ npm install --save @nestjs/swagger swagger-ui-express</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Este proyecto usa MySQL como base de datos. Debe existir una base de datos creada previamente denominada <code>tutorial</code>, tal y como aparece en el archivo <code>.env</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>El proyecto incorpora una configuración preterminada para:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>JWT en la carpeta <code>utilities</code>. La comprobación de la legitimidad de los tokens se realiza mediante la comprobación de un secreto inicializado en <code>utilities/jwt.strategy.ts</code>. Está inicializado con <code>secret</code>. Por tanto, los JWT generados para usar en esta aplicación deberán haber sido generados con el secreto inicializado a <code>secret</code>.</p>
</li>
<li>
<p>Configuración de TypeORM en el archivo <code>ormconfig.json</code> y en la carperta <code>config</code>.</p>
</li>
<li>
<p>Variables de entorno de configuración de MySQL en el archivo <code>.env</code></p>
</li>
<li>
<p>Configuración de Swagger en <code>main.ts</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Modifíquense los valores de configuración predeterminados de acuerdo con las necesidades o preferencias de cada uno.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreación-del-módulo-de-editoriales"><a class="anchor" href="#truecreación-del-módulo-de-editoriales"></a>3. Creación del módulo de editoriales</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Comenzamos creando un <code>resource</code> NestJS para las editoriales. Esto creará el módulo, controlador, servicio, DTOs y entidad.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">$ nest generate resource publishers</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-de-la-entidad"><a class="anchor" href="#trueconfiguración-de-la-entidad"></a>3.1. Configuración de la entidad</h3>
<div class="listingblock">
<div class="title">Archivo <code>publisher.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger';
import { Column, Entity, PrimaryGeneratedColumn } from 'typeorm';

@Entity() <i class="conum" data-value="1"></i><b>(1)</b>
export class Publisher {
  @ApiProperty({ example: 99 }) <i class="conum" data-value="2"></i><b>(2)</b>
  @PrimaryGeneratedColumn()
  id: number;

  @ApiProperty({ example: 'Booket' }) <i class="conum" data-value="3"></i><b>(3)</b>
  @Column()
  name: string;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador <code>@Entity</code> para indicar que se trata de una entidad</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Columna de clave primaria</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Columna para el nombre de la editorial</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-del-módulo"><a class="anchor" href="#trueconfiguración-del-módulo"></a>3.2. Configuración del módulo</h3>
<div class="listingblock">
<div class="title">Archivo <code>publishers.module.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { PublishersService } from './publishers.service';
import { PublishersController } from './publishers.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Publisher } from './entities/publisher.entity';
import { AuthModule } from '../utilities/auth.module';

@Module({
  imports: [TypeOrmModule.forFeature([Publisher]), AuthModule], <i class="conum" data-value="1"></i><b>(1)</b>
  controllers: [PublishersController],
  providers: [PublishersService],
})
export class PublishersModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añadimos los <code>imports</code> para registrar la entidad de las editoriales y el módulo de autenticación</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ponemos el proyecto en ejecución con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="bash" class="language-bash hljs">$ npm run start:dev</code></pre>
</div>
</div>
<div class="paragraph">
<p>se creará una nueva tabla <code>publisher</code> en la base de datos correspondiente a la entidad <code>Publisher</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-del-dto-de-creación-de-editoriales"><a class="anchor" href="#truecreación-del-dto-de-creación-de-editoriales"></a>3.3. Creación del DTO de creación de editoriales</h3>
<div class="paragraph">
<p>Inicialmente, las columnas de editoriales son las siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code> como identificador de la editorial.</p>
</li>
<li>
<p><code>name</code> como nombre de la editorial</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para crear una editorial configuraremos su DTO e incluiremos todas las columnas de la entidad excepto el <code>id</code>. El <code>id</code> no se pasará porque será generado por la base de datos en el momento de la inserción.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>create-publisher.dto.ts</code>:</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger';
export class CreatePublisherDto {
  @ApiProperty({ example: 'Booket' })
  readonly name: string;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-de-los-métodos-del-servicio"><a class="anchor" href="#trueimplementación-de-los-métodos-del-servicio"></a>3.4. Implementación de los métodos del servicio</h3>
<div class="listingblock">
<div class="title">Archivo <code>publishers.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable, HttpException, HttpStatus } from '@nestjs/common';
import { CreatePublisherDto } from './dto/create-publisher.dto';
import { UpdatePublisherDto } from './dto/update-publisher.dto';
import { InjectRepository } from '@nestjs/typeorm';
import { Publisher } from './entities/publisher.entity';
import { Repository } from 'typeorm';

@Injectable()
export class PublishersService {
  constructor(
    @InjectRepository(Publisher)
    private publishersRepository: Repository&lt;Publisher&gt;,
  ) {}
  create(createPublisherDto: CreatePublisherDto): Promise&lt;Publisher&gt; {
    return this.publishersRepository.save(createPublisherDto);
  }

  async findAll(): Promise&lt;Publisher[]&gt; {
    return this.publishersRepository.find();
  }

  async findOne(id: number): Promise&lt;Publisher&gt; {
    return this.publishersRepository.findOne({
      where: { id },
    });
  }

  async update(id: number, updatePublisherDto: UpdatePublisherDto) {
    if (await this.publishersRepository.findOne({ where: { id } })) {
      return this.publishersRepository.update(id, updatePublisherDto);
    }
    throw new HttpException('Publisher not found', HttpStatus.NOT_FOUND);
  }

  async remove(id: number) {
    if (await this.publishersRepository.findOne({ where: { id } })) {
      return this.publishersRepository.delete({ id });
    }
    throw new HttpException('Publisher not found', HttpStatus.NOT_FOUND);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-del-controlador"><a class="anchor" href="#trueimplementación-del-controlador"></a>3.5. Implementación del controlador</h3>
<div class="listingblock">
<div class="title">Archivo <code>publishers.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  UseGuards,
} from '@nestjs/common';
import { PublishersService } from './publishers.service';
import { CreatePublisherDto } from './dto/create-publisher.dto';
import { UpdatePublisherDto } from './dto/update-publisher.dto';
import { ApiBearerAuth, ApiTags } from '@nestjs/swagger';
import { AuthGuard } from '@nestjs/passport';

@Controller('publishers')
@ApiTags('publisher')
@UseGuards(AuthGuard('jwt'))
@ApiBearerAuth('access-token')
export class PublishersController {
  constructor(private readonly publishersService: PublishersService) {}

  @Post()
  create(@Body() createPublisherDto: CreatePublisherDto) {
    return this.publishersService.create(createPublisherDto);
  }

  @Get()
  findAll() {
    return this.publishersService.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.publishersService.findOne(+id);
  }

  @Patch(':id')
  update(
    @Param('id') id: string,
    @Body() updatePublisherDto: UpdatePublisherDto,
  ) {
    return this.publishersService.update(+id, updatePublisherDto);
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.publishersService.remove(+id);
  }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El operador <code>+</code> devuelve la expresión numérica de una variable. Lo usamos para obtener el valor numérico del parámetro <code>id</code> usado en los endopoints.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truecomprobación-de-los-endpoints"><a class="anchor" href="#truecomprobación-de-los-endpoints"></a>3.6. Comprobación de los endpoints</h3>
<div class="paragraph">
<p>Si activamos la aplicación en <code><a href="http://&lt;url&gt;:&lt;port&gt;/docs" class="bare">http://&lt;url&gt;:&lt;port&gt;/docs</a></code> veremos los endpoints de la API mostrados mediante <code>Swagger UI</code>. Si probamos a usar cualquiera de ellos obtendremos un error de acceso no autorizado porque no estamos autenticados.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/publisher-endpoints.png" alt="publisher endpoints"></span></p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="title">Obtención de un JWT</div>
<div class="paragraph">
<p>Mientras no tengamos un generador de JWT podemos usar el que ofrece <a href="https://jwt.io/">jwt.io</a>. Para obtener un JWT como el que necesitamos para usar nuestra API basta con generar uno con el secreto <code>secret</code>, que es el que usa nuestra API para comprobar que el JWT es legítmo.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/obtener-jwt.png" alt="obtener jwt"></span></p>
</div>
</div>
</div>
<div class="paragraph">
<p>Podemos copiar el JWT obtenido, pulsar el botón <code>Authorize</code> de nuestra API y pegar el JWT copiado. Esto permitirá el acceso a todos los endpoints de la API y podremos usarlas.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/usar-jwt.png" alt="usar jwt"></span></p>
</div>
<div class="paragraph">
<p>Usaremos el endpoint <code>POST /publishers</code> para crear editoriales. Al desplegar el endpoint aparece un botón de <code>Try out</code> para lanzar la petición desde <code>Swagger UI</code>. Aparece un cuerpo de ejemplo con el DTO configurado en <code>create-publisher.dto.ts</code>. Si pulsamos <code>Execute</code> creará esa editorial en la base de datos.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/editorial-creada.png" alt="editorial creada"></span></p>
</div>
<div class="paragraph">
<p>La parte de <code>Server response</code> muestra el código de estado HTTP devuelto así como la respuesta, que indica que la editorial ha sido creada y nos muestra el <code>id</code> generado por la base de datos. El objeto que devuelve es una <code>entity Publisher</code> tal y como configuramos en el método <code>create</code> del servicio <code>publishers.service.ts</code>.</p>
</div>
<div class="paragraph">
<p>Crear a continuación otra editorial con <code>"name": "Alfaguara"</code>.</p>
</div>
<div class="paragraph">
<p>Si ahora usamos el endpoint <code>GET /publishers</code> obtendremos las dos editoriales creadas.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/editoriales.png" alt="editoriales"></span></p>
</div>
<div class="paragraph">
<p>La parte de <code>Server response</code> muestra el código de estado HTTP devuelto así como la respuesta con las dos editoriales. El objeto que devuelve es un array de <code>entity Publisher</code> tal y como configuramos en el método <code>findAll</code> del servicio <code>publishers.service.ts</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreación-del-módulo-de-libros"><a class="anchor" href="#truecreación-del-módulo-de-libros"></a>4. Creación del módulo de libros</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Comenzamos creando un <code>resource</code> NestJS para los libros. Esto creará el módulo, controlador, servicio, DTOs y entidad.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">$ nest generate resource books</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-de-la-entidad-2"><a class="anchor" href="#trueconfiguración-de-la-entidad-2"></a>4.1. Configuración de la entidad</h3>
<div class="listingblock">
<div class="title">Archivo <code>book.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';
import { ApiProperty } from '@nestjs/swagger';

@Entity() <i class="conum" data-value="1"></i><b>(1)</b>
export class Book {
  @ApiProperty({ example: 99 })
  @PrimaryGeneratedColumn() <i class="conum" data-value="2"></i><b>(2)</b>
  id: number;

  @ApiProperty({ example: 'Don Quijote de la Mancha' })
  @Column() <i class="conum" data-value="3"></i><b>(3)</b>
  title: string;

  @ApiProperty({ example: 'Novela' })
  @Column()
  genre: string;

  @ApiProperty({
    example: 'Esta edición del Ingenioso hidalgo don Quijote de la Mancha ...',
  })
  @Column('text')
  description: string;

  @ApiProperty({ example: 'Miguel de Cervantes' })
  @Column()
  author: string;

  @ApiProperty({ example: 592 })
  @Column()
  pages: number;

  @ApiProperty({ example: 'www.imagen.com/quijote.png' })
  @Column()
  image_url: string;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador <code>@Entity</code> para indicar que se trata de una entidad</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Columna de clave primaria</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Columna para el título</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-del-módulo-2"><a class="anchor" href="#trueconfiguración-del-módulo-2"></a>4.2. Configuración del módulo</h3>
<div class="listingblock">
<div class="title">Archivo <code>books.module.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { BooksService } from './books.service';
import { BooksController } from './books.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Book } from './entities/book.entity';
import { AuthModule } from '../utilities/auth.module';

@Module({
  imports: [TypeOrmModule.forFeature([Book]), AuthModule], <i class="conum" data-value="1"></i><b>(1)</b>
  controllers: [BooksController],
  providers: [BooksService],
})
export class BooksModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añadimos los <code>imports</code> para registrar la entidad de los libros y el módulo de autenticación</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si teníamos el proyecto en ejecución se habrá creado una nueva tabla <code>book</code> en la base de datos correspondiente a la entidad <code>Book</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-del-dto-de-creación-de-libros"><a class="anchor" href="#truecreación-del-dto-de-creación-de-libros"></a>4.3. Creación del DTO de creación de libros</h3>
<div class="paragraph">
<p>Inicialmente, las columnas de libros son las siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code> como identificador de la editorial.</p>
</li>
<li>
<p><code>title</code> como título del libro.</p>
</li>
<li>
<p><code>genre</code> como género del libro.</p>
</li>
<li>
<p><code>description</code> como descripción del libro.</p>
</li>
<li>
<p><code>author</code> como autor del libro.</p>
</li>
<li>
<p><code>pages</code> como número de páginas del libro.</p>
</li>
<li>
<p><code>image_url</code> como URL donde localizar la portada del libro.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para crear un libro configuraremos su DTO e incluiremos todas las columnas de la entidad excepto el <code>id</code>. El <code>id</code> no se pasará porque será generado por la base de datos en el momento de la inserción.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>create-book.dto.ts</code>:</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger';

export class CreateBookDto {
  @ApiProperty({ example: 'Don Quijote de la Mancha' })
  readonly title: string;

  @ApiProperty({ example: 'Novela' })
  readonly genre: string;

  @ApiProperty({
    example: 'Esta edición del Ingenioso hidalgo don Quijote de la Mancha ...',
  })
  readonly description: string;

  @ApiProperty({ example: 'Miguel de Cervantes' })
  readonly author: string;

  @ApiProperty({ example: 592 })
  readonly pages: number;

  @ApiProperty({ example: 'www.imagen.com/quijote.png' })
  readonly image_url: string;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-de-los-métodos-del-servicio-2"><a class="anchor" href="#trueimplementación-de-los-métodos-del-servicio-2"></a>4.4. Implementación de los métodos del servicio</h3>
<div class="listingblock">
<div class="title">Archivo <code>books.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable } from '@nestjs/common';
import { CreateBookDto } from './dto/create-book.dto';
import { UpdateBookDto } from './dto/update-book.dto';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Book } from './entities/book.entity';

@Injectable()
export class BooksService {
  constructor(
    @InjectRepository(Book) private booksRepository: Repository&lt;Book&gt;,
  ) {}

  async create(createBookDto: CreateBookDto): Promise&lt;Book&gt; {
    return this.booksRepository.save(createBookDto);
  }

  async findAll(): Promise&lt;Book[]&gt; {
    return this.booksRepository.find({});
  }

  async findOne(id: number): Promise&lt;Book&gt; {
    return this.booksRepository.findOne({
      where: { id },
    });
  }

  async update(id: number, updateBookDto: UpdateBookDto): Promise&lt;Book&gt; {
    let toUpdate = await this.booksRepository.findOne({
      where: { id },
    });

    let updated = Object.assign(toUpdate, updateBookDto);

    return this.booksRepository.save(updated);
  }

  async remove(id: number): Promise&lt;any&gt; {
    return this.booksRepository.delete({ id });
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-del-controlador-2"><a class="anchor" href="#trueimplementación-del-controlador-2"></a>4.5. Implementación del controlador</h3>
<div class="listingblock">
<div class="title">Archivo <code>books.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  UseGuards,
} from '@nestjs/common';
import { BooksService } from './books.service';
import { CreateBookDto } from './dto/create-book.dto';
import { UpdateBookDto } from './dto/update-book.dto';
import { ApiTags, ApiBearerAuth } from '@nestjs/swagger';
import { AuthGuard } from '@nestjs/passport';

@Controller('books')
@ApiTags('book')
@UseGuards(AuthGuard('jwt'))
@ApiBearerAuth('access-token')
export class BooksController {
  constructor(private readonly booksService: BooksService) {}

  @Post()
  create(@Body() createBookDto: CreateBookDto) {
    return this.booksService.create(createBookDto);
  }

  @Get()
  findAll() {
    return this.booksService.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.booksService.findOne(+id);
  }

  @Patch(':id')
  update(@Param('id') id: string, @Body() updateBookDto: UpdateBookDto) {
    return this.booksService.update(+id, updateBookDto);
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.booksService.remove(+id);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecomprobación-de-los-endpoints-2"><a class="anchor" href="#truecomprobación-de-los-endpoints-2"></a>4.6. Comprobación de los endpoints</h3>
<div class="paragraph">
<p>Si activamos la aplicación en <code><a href="http://&lt;url&gt;:&lt;port&gt;/docs" class="bare">http://&lt;url&gt;:&lt;port&gt;/docs</a></code> veremos que ya están disponibles los endpoints de los libros. Tras autenticarnos con un JWT crearemos un libro y comprobaremos que se recupera de la base de datos.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/book-endpoints.png" alt="book endpoints"></span></p>
</div>
<div class="paragraph">
<p>Usaremos el endpoint <code>POST /books</code> para crear libros. Al desplegar el endpoint pulsaremos el botón de <code>Try out</code> para lanzar la petición desde <code>Swagger UI</code>. Aparece un cuerpo de ejemplo con el DTO configurado en <code>create-book.dto.ts</code>. Si pulsamos <code>Execute</code> creará ese libro en la base de datos.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/libro-creado.png" alt="libro creado"></span></p>
</div>
<div class="paragraph">
<p>La parte de <code>Server response</code> muestra el código de estado HTTP devuelto así como la respuesta, que indica que el libro ha sido creado y nos muestra el <code>id</code> generado por la base de datos. El objeto que devuelve es una <code>entity Book</code> tal y como configuramos en el método <code>create</code> del servicio <code>books.service.ts</code>.</p>
</div>
<div class="paragraph">
<p>Si ahora usamos el endpoint <code>GET /books</code> obtendremos el libro creado.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/libros.png" alt="libros"></span></p>
</div>
<div class="paragraph">
<p>La parte de <code>Server response</code> muestra el código de estado HTTP devuelto así como la respuesta con el libro. El objeto que devuelve es un array de <code>entity Book</code> tal y como configuramos en el método <code>findAll</code> del servicio <code>books.service.ts</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreación-del-módulo-de-comentarios"><a class="anchor" href="#truecreación-del-módulo-de-comentarios"></a>5. Creación del módulo de comentarios</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Comenzamos creando un <code>resource</code> NestJS para los comentarios. Esto creará el módulo, controlador, servicio, DTOs y entidad.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">$ nest generate resource comments</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-de-la-entidad-3"><a class="anchor" href="#trueconfiguración-de-la-entidad-3"></a>5.1. Configuración de la entidad</h3>
<div class="listingblock">
<div class="title">Archivo <code>comment.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger';
import { PrimaryGeneratedColumn, Column, Entity } from 'typeorm';

@Entity() <i class="conum" data-value="1"></i><b>(1)</b>
export class Comment {
  @ApiProperty({ example: 99 })
  @PrimaryGeneratedColumn() <i class="conum" data-value="2"></i><b>(2)</b>
  id: number;

  @ApiProperty({ example: 'Genial!!' })
  @Column()
  title: string; <i class="conum" data-value="3"></i><b>(3)</b>

  @ApiProperty({ example: 5 })
  @Column()
  stars: number;

  @ApiProperty({
    example:
      'Compré el libro por los comentarios tan buenos que tenía. El libro comentá la historia de España de manera muy general y desde un punto de vista súper simplista. Resumiendo temas de compleja explicación en tan solo una frase. ',
  })
  @Column('text')
  comment: string;

  @ApiProperty({ example: 'johndoe' })
  @Column()
  username: string;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador <code>@Entity</code> para indicar que se trata de una entidad</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Columna de clave primaria</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Columna para el título del comentario</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-del-módulo-3"><a class="anchor" href="#trueconfiguración-del-módulo-3"></a>5.2. Configuración del módulo</h3>
<div class="listingblock">
<div class="title">Archivo <code>comments.module.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { CommentsService } from './comments.service';
import { CommentsController } from './comments.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { AuthModule } from '../utilities/auth.module';
import { Comment } from './entities/comment.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Comment]), AuthModule], <i class="conum" data-value="1"></i><b>(1)</b>
  controllers: [CommentsController],
  providers: [CommentsService],
})
export class CommentsModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añadimos los <code>imports</code> para registrar la entidad de los comentarios y el módulo de autenticación</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si teníamos el proyecto en ejecución se habrá creado una nueva tabla <code>comment</code> en la base de datos correspondiente a la entidad <code>Comment</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-del-dto-de-creación-de-comentarios"><a class="anchor" href="#truecreación-del-dto-de-creación-de-comentarios"></a>5.3. Creación del DTO de creación de comentarios</h3>
<div class="paragraph">
<p>Inicialmente, las columnas de comentarios son las siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code> como identificador del comentario.</p>
</li>
<li>
<p><code>title</code> como título del comentario.</p>
</li>
<li>
<p><code>stars</code> como valoración en forma de estrellas que tiene el comentario.</p>
</li>
<li>
<p><code>comment</code> como descripción del comentario.</p>
</li>
<li>
<p><code>username</code> como autor del comentario.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para crear un comentario configuraremos su DTO e incluiremos todas las columnas de la entidad excepto el <code>id</code>. El <code>id</code> no se pasará porque será generado por la base de datos en el momento de la inserción.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>create-comment.dto.ts</code>:</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger';
export class CreateCommentDto {
  @ApiProperty({ example: 'Genial!!' })
  readonly title: string;

  @ApiProperty({ example: 5 })
  readonly stars: number;

  @ApiProperty({
    example:
      'Compré el libro por los comentarios tan buenos que tenía. El libro comentá la historia de España de manera muy general y desde un punto de vista súper simplista. Resumiendo temas de compleja explicación en tan solo una frase. ',
  })
  readonly comment: string;

  @ApiProperty({ example: 'johndoe' })
  readonly username: string;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-de-los-métodos-del-servicio-3"><a class="anchor" href="#trueimplementación-de-los-métodos-del-servicio-3"></a>5.4. Implementación de los métodos del servicio</h3>
<div class="listingblock">
<div class="title">Archivo <code>comments.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable } from '@nestjs/common';
import { CreateCommentDto } from './dto/create-comment.dto';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { UpdateCommentDto } from './dto/update-comment.dto';
import { Comment } from './entities/comment.entity';

@Injectable()
export class CommentsService {
  constructor(
    @InjectRepository(Comment)
    private commentsRepository: Repository&lt;Comment&gt;,
  ) {}
  create(createCommentDto: CreateCommentDto): Promise&lt;Comment&gt; {
    return this.commentsRepository.save(createCommentDto);
  }

  async findAll(): Promise&lt;Comment[]&gt; {
    return this.commentsRepository.find();
  }

  async findOne(id: number): Promise&lt;Comment&gt; {
    return this.commentsRepository.findOne({
      where: { id },
    });
  }

  async update(id: number, updateCommentDto: UpdateCommentDto) {
    return this.commentsRepository.update(id, updateCommentDto);
  }

  async remove(id: number) {
    return this.commentsRepository.delete({ id });
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-del-controlador-3"><a class="anchor" href="#trueimplementación-del-controlador-3"></a>5.5. Implementación del controlador</h3>
<div class="listingblock">
<div class="title">Archivo <code>comments.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  UseGuards,
} from '@nestjs/common';
import { CommentsService } from './comments.service';
import { CreateCommentDto } from './dto/create-comment.dto';
import { UpdateCommentDto } from './dto/update-comment.dto';
import { ApiTags, ApiBearerAuth } from '@nestjs/swagger';
import { AuthGuard } from '@nestjs/passport';

@Controller('comments')
@ApiTags('comment')
@UseGuards(AuthGuard('jwt'))
@ApiBearerAuth('access-token')
export class CommentsController {
  constructor(private readonly commentsService: CommentsService) {}

  @Post()
  create(@Body() createCommentDto: CreateCommentDto) {
    return this.commentsService.create(createCommentDto);
  }

  @Get()
  findAll() {
    return this.commentsService.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.commentsService.findOne(+id);
  }

  @Patch(':id')
  update(@Param('id') id: string, @Body() updateCommentDto: UpdateCommentDto) {
    return this.commentsService.update(+id, updateCommentDto);
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.commentsService.remove(+id);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecomprobación-de-los-endpoints-3"><a class="anchor" href="#truecomprobación-de-los-endpoints-3"></a>5.6. Comprobación de los endpoints</h3>
<div class="paragraph">
<p>Si activamos la aplicación en <code><a href="http://&lt;url&gt;:&lt;port&gt;/docs" class="bare">http://&lt;url&gt;:&lt;port&gt;/docs</a></code> veremos que ya están disponibles los endpoints de los comentarios. Tras autenticarnos con un JWT crearemos un par de comentarios y comprobaremos que se recuperan de la base de datos.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/comment-endpoints.png" alt="comment endpoints"></span></p>
</div>
<div class="paragraph">
<p>Usaremos el endpoint <code>POST /comments</code> para crear comentarios. Al desplegar el endpoint pulsaremos el botón de <code>Try out</code> para lanzar la petición desde <code>Swagger UI</code>. Aparece un cuerpo de ejemplo con el DTO configurado en <code>create-comment.dto.ts</code>. Si pulsamos <code>Execute</code> creará ese comentario en la base de datos.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/comentario-creado.png" alt="comentario creado"></span></p>
</div>
<div class="paragraph">
<p>La parte de <code>Server response</code> muestra el código de estado HTTP devuelto así como la respuesta, que indica que el comentario ha sido creado y nos muestra el <code>id</code> generado por la base de datos. El objeto que devuelve es una <code>entity Comment</code> tal y como configuramos en el método <code>create</code> del servicio <code>comments.service.ts</code>.</p>
</div>
<div class="paragraph">
<p>Crear a continuación otro comentario con estos valores</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "title": "Le falló el final",
  "stars": 4,
  "comment": "Una aventura magnífica que se quedó un poco corta en su final",
  "username": "marysmith"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si ahora usamos el endpoint <code>GET /comments</code> obtendremos los comentarios creados.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/comentarios.png" alt="comentarios"></span></p>
</div>
<div class="paragraph">
<p>La parte de <code>Server response</code> muestra el código de estado HTTP devuelto así como la respuesta con los comentarios. El objeto que devuelve es un array de <code>entity Comment</code> tal y como configuramos en el método <code>findAll</code> del servicio <code>comments.service.ts</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreación-del-módulo-de-palabras-clave"><a class="anchor" href="#truecreación-del-módulo-de-palabras-clave"></a>6. Creación del módulo de palabras clave</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Comenzamos creando un <code>resource</code> NestJS para las palabras clave. Esto creará el módulo, controlador, servicio, DTOs y entidad.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">$ nest generate resource keywords</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-de-la-entidad-4"><a class="anchor" href="#trueconfiguración-de-la-entidad-4"></a>6.1. Configuración de la entidad</h3>
<div class="listingblock">
<div class="title">Archivo <code>keyword.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Entity, PrimaryGeneratedColumn, Column } from 'typeorm';
import { ApiProperty } from '@nestjs/swagger';
@Entity()
export class Keyword {
  @ApiProperty({ example: 99 })
  @PrimaryGeneratedColumn()
  id: number;

  @ApiProperty({ example: 'NestJS' })
  @Column()
  keyword: string;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador <code>@Entity</code> para indicar que se trata de una entidad</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Columna de clave primaria</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Columna para la palabra clave</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueconfiguración-del-módulo-4"><a class="anchor" href="#trueconfiguración-del-módulo-4"></a>6.2. Configuración del módulo</h3>
<div class="listingblock">
<div class="title">Archivo <code>keywords.module.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Module } from '@nestjs/common';
import { KeywordsService } from './keywords.service';
import { KeywordsController } from './keywords.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Keyword } from './entities/keyword.entity';
import { AuthModule } from '../utilities/auth.module';

@Module({
  imports: [TypeOrmModule.forFeature([Keyword]), AuthModule], <i class="conum" data-value="1"></i><b>(1)</b>
  controllers: [KeywordsController],
  providers: [KeywordsService],
})
export class KeywordsModule {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Añadimos los <code>imports</code> para registrar la entidad de las palabras clave y el módulo de autenticación</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si teníamos el proyecto en ejecución se habrá creado una nueva tabla <code>keyword</code> en la base de datos correspondiente a la entidad <code>Keyword</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-del-dto-de-creación-de-palabras-clave"><a class="anchor" href="#truecreación-del-dto-de-creación-de-palabras-clave"></a>6.3. Creación del DTO de creación de palabras clave</h3>
<div class="paragraph">
<p>Inicialmente, las columnas de palabras clave son las siguientes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code> como identificador de la palabra clave.</p>
</li>
<li>
<p><code>keyword</code> como palabra clave.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Para crear una palabra clave configuraremos su DTO e incluiremos todas las columnas de la entidad excepto el <code>id</code>. El <code>id</code> no se pasará porque será generado por la base de datos en el momento de la inserción.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>create-keyword.dto.ts</code>:</div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger';
export class CreateKeywordDto {
  @ApiProperty({ example: 'NestJS' })
  readonly keyword: string;
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-de-los-métodos-del-servicio-4"><a class="anchor" href="#trueimplementación-de-los-métodos-del-servicio-4"></a>6.4. Implementación de los métodos del servicio</h3>
<div class="listingblock">
<div class="title">Archivo <code>keywords.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Injectable } from '@nestjs/common';
import { CreateKeywordDto } from './dto/create-keyword.dto';
import { UpdateKeywordDto } from './dto/update-keyword.dto';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Keyword } from './entities/keyword.entity';

@Injectable()
export class KeywordsService {
  constructor(
    @InjectRepository(Keyword)
    private keywordsRepository: Repository&lt;Keyword&gt;,
  ) {}
  create(createKeywordDto: CreateKeywordDto): Promise&lt;Keyword&gt; {
    return this.keywordsRepository.save(createKeywordDto);
  }

  async findAll(): Promise&lt;Keyword[]&gt; {
    return this.keywordsRepository.find();
  }

  async findOne(id: number): Promise&lt;Keyword&gt; {
    return this.keywordsRepository.findOne({
      where: { id },
    });
  }

  findBooks(id: number): Promise&lt;Keyword&gt; {
    return this.keywordsRepository.findOne({
      where: { id },
    });
  }

  async update(id: number, updateKeywordDto: UpdateKeywordDto) {
    return this.keywordsRepository.update(id, updateKeywordDto);
  }

  async remove(id: number) {
    return this.keywordsRepository.delete({ id });
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueimplementación-del-controlador-4"><a class="anchor" href="#trueimplementación-del-controlador-4"></a>6.5. Implementación del controlador</h3>
<div class="listingblock">
<div class="title">Archivo <code>comments.controller.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import {
  Controller,
  Get,
  Post,
  Body,
  Patch,
  Param,
  Delete,
  UseGuards,
} from '@nestjs/common';
import { KeywordsService } from './keywords.service';
import { CreateKeywordDto } from './dto/create-keyword.dto';
import { UpdateKeywordDto } from './dto/update-keyword.dto';
import { ApiTags, ApiBearerAuth } from '@nestjs/swagger';
import { AuthGuard } from '@nestjs/passport';

@Controller('keywords')
@ApiTags('keyword')
@UseGuards(AuthGuard('jwt'))
@ApiBearerAuth('access-token')
export class KeywordsController {
  constructor(private readonly keywordsService: KeywordsService) {}

  @Post()
  create(@Body() createKeywordDto: CreateKeywordDto) {
    return this.keywordsService.create(createKeywordDto);
  }

  @Get()
  findAll() {
    return this.keywordsService.findAll();
  }

  @Get(':id')
  findOne(@Param('id') id: string) {
    return this.keywordsService.findOne(+id);
  }

  @Patch(':id')
  update(@Param('id') id: string, @Body() updateKeywordDto: UpdateKeywordDto) {
    return this.keywordsService.update(+id, updateKeywordDto);
  }

  @Delete(':id')
  remove(@Param('id') id: string) {
    return this.keywordsService.remove(+id);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecomprobación-de-los-endpoints-4"><a class="anchor" href="#truecomprobación-de-los-endpoints-4"></a>6.6. Comprobación de los endpoints</h3>
<div class="paragraph">
<p>Si activamos la aplicación en <code><a href="http://&lt;url&gt;:&lt;port&gt;/docs" class="bare">http://&lt;url&gt;:&lt;port&gt;/docs</a></code> veremos que ya están disponibles los endpoints de las palabras clave. Tras autenticarnos con un JWT crearemos dos palabras clave y comprobaremos que se recuperan de la base de datos.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/keyword-endpoints.png" alt="keyword endpoints"></span></p>
</div>
<div class="paragraph">
<p>Usaremos el endpoint <code>POST /keywords</code> para crear palabras clave. Al desplegar el endpoint pulsaremos el botón de <code>Try out</code> para lanzar la petición desde <code>Swagger UI</code>. Aparece un cuerpo de ejemplo con el DTO configurado en <code>create-keyword.dto.ts</code>. Si pulsamos <code>Execute</code> creará esa palabra clave en la base de datos.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/palabra-clave-creada.png" alt="palabra clave creada"></span></p>
</div>
<div class="paragraph">
<p>La parte de <code>Server response</code> muestra el código de estado HTTP devuelto así como la respuesta, que indica que la palabra clave ha sido creada y nos muestra el <code>id</code> generado por la base de datos. El objeto que devuelve es una <code>entity Keyword</code> tal y como configuramos en el método <code>create</code> del servicio <code>keywords.service.ts</code>.</p>
</div>
<div class="paragraph">
<p>Crear a continuación otra editorial con "keyword": "REST API".</p>
</div>
<div class="paragraph">
<p>Si ahora usamos el endpoint <code>GET /keywords</code> obtendremos los comentarios creados.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/palabras-clave.png" alt="palabras clave"></span></p>
</div>
<div class="paragraph">
<p>La parte de <code>Server response</code> muestra el código de estado HTTP devuelto así como la respuesta con las palabras clave. El objeto que devuelve es un array de <code>entity Keyword</code> tal y como configuramos en el método <code>findAll</code> del servicio <code>keywords.service.ts</code>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreación-de-las-relaciones"><a class="anchor" href="#truecreación-de-las-relaciones"></a>7. Creación de las relaciones</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora nos hemos limitado a crear los módulos de la API teniendo en cuenta únicamente los objetos o entidades que existen en nuestro proyecto desde el punto de vista de bases de datos. Es decir, nos hemos limitado a reflejar en las entidades las propiedades propias de cada objeto del dominio. Sin embargo, no hemos prestado atención aún a las relaciones existentes entre ellos y a su implicación en la implementación de los servicios. Esto último hace referencia a que si entre <code>Book</code> y <code>Comment</code> existe una relación <code>1:M</code>, nos planteamos mostrar los comentarios de cada libro al recuperar un libro. Esto posiblemente implicaría una modificación de los métodos del servicio de <code>Book</code> para que recuperase los comentarios asociados a cada libro.</p>
</div>
<div class="paragraph">
<p>En esta sección veremos cómo definir las relaciones entre entidades y realizaremos los cambios en los servicios para <em>hidratar</em> o enriquecer cada objeto con los datos de sus objetos relacionados.</p>
</div>
<div class="sect2">
<h3 id="truecreación-de-la-relación-entre-book-y-publisher"><a class="anchor" href="#truecreación-de-la-relación-entre-book-y-publisher"></a>7.1. Creación de la relación entre <code>Book</code> y <code>Publisher</code></h3>
<div class="paragraph">
<p>Entre las entidades <code>Book</code> y <code>Publisher</code> hay una relación <code>M:1</code>. Podemos hacer la relación unidireccional o bidireccional. En este tutorial la haremos bidireccional para que podamos mostrar la editorial de un libro así como los libros de una editorial.</p>
</div>
<div class="sect3">
<h4 id="truemodificación-de-las-entidades"><a class="anchor" href="#truemodificación-de-las-entidades"></a>7.1.1. Modificación de las entidades</h4>
<div class="paragraph">
<p>Comenzamos añadiendo los cambios a las entidades. Lo haremos en dos pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añadir los campos a cada entidad.</p>
</li>
<li>
<p>Añadir a cada entidad los decoradores de las relaciones.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Lo hacemos en dos pasos porque los decoradores usan los nombres de campo del otro extremo de la relación. Por tanto, para no provocar errores durante la creación de las relaciones definiremos primero los campos para poder referenciarlos al crear las relaciones en el segundo paso.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En relaciones unidireccionales sólo se crea el campo y el decorador de relación en una entidad.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="trueañadir-los-campos-a-cada-entidad"><a class="anchor" href="#trueañadir-los-campos-a-cada-entidad"></a>Añadir los campos a cada entidad.</h5>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Book</code> para añadir un nuevo campo <code>publisher</code>, cuyo tipo es <code>Publisher</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>book.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { Publisher } from '../../publishers/entities/publisher.entity'; <i class="conum" data-value="1"></i><b>(1)</b>

@Entity()
export class Book {
  ...

  @ApiProperty({ example: 'www.imagen.com/quijote.png' })
  @Column()
  image_url: string;

  publisher: Publisher; <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación de la entidad <code>Publisher</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creación del campo <code>publisher</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Publisher</code> para añadir un nuevo campo <code>books</code>, cuyo tipo es <code>Book[]</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>publisher.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger';
import { Column, Entity, PrimaryGeneratedColumn } from 'typeorm';
import { Book } from '../../books/entities/book.entity'; <i class="conum" data-value="1"></i><b>(1)</b>

@Entity()
export class Publisher {
  @ApiProperty({ example: 99 })
  @PrimaryGeneratedColumn()
  id: number;

  @ApiProperty({ example: 'Booket' })
  @Column()
  name: string;

  books: Book[]; <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación de la entidad <code>Book</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creación del campo <code>books</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por ahora, ninguno de las campos introducidos en las entidades <code>Book</code> y <code>Publisher</code> tienen efecto sobre la base de datos. Esto se debe a que ni han sido decorados con <code>@Column()</code> ni con ninguna relación. Por ahora, son sólo campos de la clase, pero no han pasado a la base de datos.</p>
</div>
</div>
<div class="sect4">
<h5 id="trueañadir-los-decoradores-de-relación-a-cada-entidad"><a class="anchor" href="#trueañadir-los-decoradores-de-relación-a-cada-entidad"></a>Añadir los decoradores de relación a cada entidad</h5>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Book</code> para añadir la relación <code>M:1</code> con <code>Publisher</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>book.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
@Entity()
export class Book {

    ...

  @ApiProperty({ example: 'www.imagen.com/quijote.png' })
  @Column()
  image_url: string;

  @ApiProperty({ example: { id: 1 } }) <i class="conum" data-value="1"></i><b>(1)</b>
  @ManyToOne( <i class="conum" data-value="2"></i><b>(2)</b>
    () =&gt; Publisher, <i class="conum" data-value="3"></i><b>(3)</b>
    publisher =&gt; publisher.books, <i class="conum" data-value="4"></i><b>(4)</b>
  )
  publisher: Publisher;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Al ser un objeto, para introducir una editorial incluiremos el nombre de campo del identificador de la editorial y un valor</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Decorador para la relación <code>M:1</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Definición del tipo (del otro extremo) de la relación</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Definición de la propiedad inversa.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para la definición de la propiedad se establece un objeto (<code>publisher</code>) de la entidad del otro extremo y se indica el campo que establece la relación inversa (<code>publisher.books</code>).</p>
</div>
<div class="paragraph">
<p>Al guardar los cambios en la entidad, ya sí se trasladan los cambios a la base de datos. Así, la tabla <code>book</code> ahora contiene una nueva columna para la editorial del libro.</p>
</div>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Publisher</code> para añadir la relación <code>1:M</code> con <code>Book</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>publisher.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { ApiProperty } from '@nestjs/swagger';
import { Column, Entity, OneToMany, PrimaryGeneratedColumn } from 'typeorm';
import { Book } from '../../books/entities/book.entity';

@Entity()
export class Publisher {
  @ApiProperty({ example: 99 })
  @PrimaryGeneratedColumn()
  id: number;

  @ApiProperty({ example: 'Booket' })
  @Column()
  name: string;

  @OneToMany( <i class="conum" data-value="1"></i><b>(1)</b>
    () =&gt; Book, <i class="conum" data-value="2"></i><b>(2)</b>
    book =&gt; book.publisher, <i class="conum" data-value="3"></i><b>(3)</b>
  )
  books: Book[];
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador para la relación <code>1:M</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definición del tipo (del otro extremo) de la relación</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Definición de la propiedad inversa.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para la definición de la propiedad se establece un objeto (<code>book</code>) de la entidad del otro extremo y se indica el campo que establece la relación inversa (<code>book.publisher</code>).</p>
</div>
<div class="paragraph">
<p>Al guardar los cambios en la entidad, estos cambios <strong>no se trasladan</strong> a la base de datos, ya que en relaciones <code>M:1</code> se añade la clave de la entidad que actúa como <code>1</code> (<code>publisher</code>) a la tabla de la entidad que actúa como <code>M</code> (<code>book</code>).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truemodificación-del-dto"><a class="anchor" href="#truemodificación-del-dto"></a>7.1.2. Modificación del DTO</h4>
<div class="paragraph">
<p>En este paso se modifican los DTO afectados. Para el caso de los libros habrá que modificar el DTO <code>create-book.dto.ts</code> para añadirle la editorial de un libro. Este DTO se usará tanto para la creación de nuevos libros como para la modificación de libros existentes. En cualquier caso, el valor introducido para editorial deberá ser un objeto con el campo <code>id</code> y el identificador de la editorial del libro. Por tanto. la editorial deberá existir previamente antes de asignarla a un libro.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>create-book.dto.ts</code></div>
<div class="content">
<pre>...
export class CreateBookDto {
  ...

  @ApiProperty({ example: 'www.imagen.com/quijote.png' })
  readonly image_url: string;

  @ApiProperty({ example: { id: 1 } }) <i class="conum" data-value="1"></i><b>(1)</b>
  readonly publisher: Publisher; <i class="conum" data-value="2"></i><b>(2)</b>
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ejemplo de referencia a una editorial</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nuevo campo para el DTO</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación introduciremos un nuevo libro pasándole como valor de <code>publisher</code> el objeto <code>{"id": 1}</code>, que de acuerdo con nuestra base de datos es la editorial <code>Booket</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "title": "Historia de España contada para escépticos",
  "genre": "Historia",
  "description": "Como escribe el autor, no pretende ser veraz, justa y desapasionada, porque ninguna historia lo es. No está hecha para halagar a reyes y gobernantes, ni pretende halagar a los banqueros, ni a la Conferencia Episcopal, ni al colectivo gay.",
  "author": "Juan Eslava Galán",
  "pages": 592,
  "image_url": "https://images-na.ssl-images-amazon.com/images/I/51IyZ5Mq8YL._SX326_BO1,204,203,200_.jpg",
  "publisher": {
    "id": 1
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras la inserción vemos que el servidor responde correctamente mostrando el código de estado HTTP de la creación del libro y devuelvel el libro creado con el nuevo identificador generado por la base de datos.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/libro-insertado-con-editorial.png" alt="libro insertado con editorial"></span></p>
</div>
<div class="paragraph">
<p>Del mismo modo, podemos modificar el primer libro para añadirle la editorial. Habría que usar el endpoint <code>PATCH /books/{id}</code> y pasarle como <code>body</code> el objeto de la editorial al que se quiere asignar. Como el libro <code>1</code> es de la editorial <code>Alfaguara</code>, que es la <code>2</code> haríamos la modificación tal y como indica la figura siguiente.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/asignar-editorial-a-libro.png" alt="asignar editorial a libro"></span></p>
</div>
<div class="paragraph">
<p>Sin embargo, si recuperamos los libros con el endpoint <code>GET /books</code> veremos que el libro aparece, pero no la editorial. En la sección siguiente veremos cómo modificar <code>books.service.ts</code> para que devuelva los datos de la editorial al recuperar un libro.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/libros-sin-editorial.png" alt="libros sin editorial"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="truemodificación-de-los-servicios-para-que-devuelvan-los-datos-relacionados"><a class="anchor" href="#truemodificación-de-los-servicios-para-que-devuelvan-los-datos-relacionados"></a>7.1.3. Modificación de los servicios para que devuelvan los datos relacionados.</h4>
<div class="paragraph">
<p>TypeORM permite que a la familia de métodos <code>find</code> se le pase un elemento <code>relations</code> configurando un array de relaciones para indicar las entidades relacionadas que se deberían cargar. En nuestro caso tendremos que hacer modificaciones en:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El servicio de libros para que muestre la editorial al recuperar los libros.</p>
</li>
<li>
<p>El servicio de editoriales para que se muestren los libros al recuperar una editorial.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Veamos cómo hacerlo.</p>
</div>
<div class="paragraph">
<p>Comenzaremos modificando el servicio de libros para que cargue las editoriales al recuperar un libro. Se trata de incluir la relación <code>publisher</code> en los métodos <code>find</code> y <code>findOne</code> de <code>books.service.ts</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>books.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...

@Injectable()
export class BooksService {
  ...

  async findAll(): Promise&lt;Book[]&gt; {
    return this.booksRepository.find({ relations: ['publisher'] }); <i class="conum" data-value="1"></i><b>(1)</b>
  }

  async findOne(id: number): Promise&lt;Book&gt; {
    return this.booksRepository.findOne({
      where: { id },
      relations: ['publisher'], <i class="conum" data-value="2"></i><b>(2)</b>
    });
  }

  ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Carga de las editoriales relacionadas al recuperar los libros</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Carga de la editorial relacionada al recuperar un libro</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora recuperamos los libros con el endpoint <code>GET /books</code> vemos que ya se incorpora la editorial a cada libro.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/libros-hidratados-con-editoriales.png" alt="libros hidratados con editoriales"></span></p>
</div>
<div class="paragraph">
<p>A continuación modificamos el servicio de editoriales para que cargue los libros al recuperar una ediorial. Se trata de incluir la relación <code>books</code> en los métodos <code>find</code> y <code>findOne</code> de <code>publishers.service.ts</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>publishers.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...

@Injectable()
export class PublishersService {
  ...

  async findAll(): Promise&lt;Publisher[]&gt; {
    return this.publishersRepository.find({ relations: ['books'] }); <i class="conum" data-value="1"></i><b>(1)</b>
  }

  async findOne(id: number): Promise&lt;Publisher&gt; {
    return this.publishersRepository.findOne({
      where: { id },
      relations: ['books'], <i class="conum" data-value="2"></i><b>(2)</b>
    });
  }

  ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Carga de los libros relacionadas al recuperar las editoriales</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Carga de los libros relacionados al recuperar una editorial</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora recuperamos las editoriales con el endpoint <code>GET /publishers</code> vemos que ya se incorpora los libros a cada editorial.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/editorial-hidratada-con-libros.png" alt="editorial hidratada con libros"></span></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-de-la-relación-entre-book-y-comment"><a class="anchor" href="#truecreación-de-la-relación-entre-book-y-comment"></a>7.2. Creación de la relación entre <code>Book</code> y <code>Comment</code></h3>
<div class="paragraph">
<p>Entre las entidades <code>Book</code> y <code>Comment</code> hay una relación <code>1:M</code>. Podemos hacer la relación unidireccional o bidireccional. En este tutorial la haremos bidireccional para que podamos mostrar los comentarios de un libro así como ver a qué libro corresponde un comentario.</p>
</div>
<div class="sect3">
<h4 id="truemodificación-de-las-entidades-2"><a class="anchor" href="#truemodificación-de-las-entidades-2"></a>7.2.1. Modificación de las entidades</h4>
<div class="paragraph">
<p>Comenzamos añadiendo los cambios a las entidades. Lo haremos en dos pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añadir los campos a cada entidad.</p>
</li>
<li>
<p>Añadir a cada entidad los decoradores de las relaciones.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Tal y como hemos comentado, lo hacemos en dos pasos porque los decoradores usan los nombres de campo del otro extremo de la relación. Por tanto, para no provocar errores durante la creación de las relaciones definiremos primero los campos para poder referenciarlos al crear las relaciones en el segundo paso.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En relaciones unidireccionales sólo se crea el campo y el decorador de relación en una entidad.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="trueañadir-los-campos-a-cada-entidad-2"><a class="anchor" href="#trueañadir-los-campos-a-cada-entidad-2"></a>Añadir los campos a cada entidad.</h5>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Book</code> para añadir un nuevo campo <code>comments</code>, cuyo tipo es <code>Comment[]</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>book.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { Comment } from '../../comments/entities/comment.entity'; <i class="conum" data-value="1"></i><b>(1)</b>

@Entity()
export class Book {
  ...

  @ApiProperty({ example: { id: 1 } })
  @ManyToOne(() =&gt; Publisher, (publisher: Publisher) =&gt; publisher.books)
  publisher: Publisher;

  comments: Comment[]; <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación de la entidad <code>Comment</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creación del campo <code>books</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Comment</code> para añadir un nuevo campo <code>book</code>, cuyo tipo es <code>Book</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>comment.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { Book } from '../../books/entities/book.entity'; <i class="conum" data-value="1"></i><b>(1)</b>

@Entity()
export class Comment {
  ...

  @ApiProperty({ example: 'johndoe' })
  @Column()
  username: string;

  book: Book; <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación de la entidad <code>Book</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creación del campo <code>book</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por ahora, ninguno de las campos introducidos en las entidades <code>Book</code> y <code>Comment</code> tienen efecto sobre la base de datos. Esto se debe a que ni han sido decorados con <code>@Column()</code> ni con ninguna relación. Por ahora, son sólo campos de la clase, pero no han pasado a la base de datos.</p>
</div>
</div>
<div class="sect4">
<h5 id="trueañadir-los-decoradores-de-relación-a-cada-entidad-2"><a class="anchor" href="#trueañadir-los-decoradores-de-relación-a-cada-entidad-2"></a>Añadir los decoradores de relación a cada entidad</h5>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Book</code> para añadir la relación <code>1:M</code> con <code>Comment</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>book.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { Entity, Column, PrimaryGeneratedColumn, ManyToOne, OneToMany } from 'typeorm';
import { ApiProperty } from '@nestjs/swagger';
import { Publisher } from '../../publishers/entities/publisher.entity';
import { Comment } from '../../comments/entities/comment.entity';

@Entity()
export class Book {
  @ApiProperty({ example: 99 })
  @PrimaryGeneratedColumn()
  id: number;

  @ApiProperty({ example: 'Don Quijote de la Mancha' })
  @Column()
  title: string;

  @ApiProperty({ example: 'Novela' })
  @Column()
  genre: string;

  @ApiProperty({
    example: 'Esta edición del Ingenioso hidalgo don Quijote de la Mancha ...',
  })
  @Column('text')
  description: string;

  @ApiProperty({ example: 'Miguel de Cervantes' })
  @Column()
  author: string;

  @ApiProperty({ example: 592 })
  @Column()
  pages: number;

  @ApiProperty({ example: 'www.imagen.com/quijote.png' })
  @Column()
  image_url: string;

  @ApiProperty({ example: { id: 1 } })
  @ManyToOne(() =&gt; Publisher, (publisher: Publisher) =&gt; publisher.books)
  publisher: Publisher;

  @OneToMany( <i class="conum" data-value="1"></i><b>(1)</b>
    () =&gt; Comment, <i class="conum" data-value="2"></i><b>(2)</b>
    (comments: Comment) =&gt; comments.book, <i class="conum" data-value="3"></i><b>(3)</b>
  )
  comments: Comment[];
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador para la relación <code>1:M</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definición del tipo (del otro extremo) de la relación</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Definición de la propiedad inversa.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para la definición de la propiedad se establece un objeto (<code>comments</code>) de la entidad del otro extremo y se indica el campo que establece la relación inversa (<code>comments.book</code>).</p>
</div>
<div class="paragraph">
<p>Al guardar los cambios en la entidad, estos cambios <strong>no se trasladan</strong> a la base de datos, ya que en relaciones <code>1:M</code> se añade la clave de la entidad que actúa como <code>1</code> (<code>Book</code>) a la tabla de la entidad que actúa como <code>M</code> (<code>Comment</code>).</p>
</div>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Comment</code> para añadir la relación <code>M:1</code> con <code>Book</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>comment.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...

@Entity()
export class Comment {
  ...

  @ApiProperty({ example: 'johndoe' })
  @Column()
  username: string;

  @ManyToOne(
    () =&gt; Book,
    (book: Book) =&gt; book.comments,
  )
  book: Book;
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador para la relación <code>M:1</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definición del tipo (del otro extremo) de la relación</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Definición de la propiedad inversa.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para la definición de la propiedad se establece un objeto (<code>book</code>) de la entidad del otro extremo y se indica el campo que establece la relación inversa (<code>book.comments</code>).</p>
</div>
<div class="paragraph">
<p>Al guardar los cambios en la entidad, ya sí se trasladan los cambios a la base de datos. Así, la tabla <code>comment</code> ahora contiene una nueva columna para el identificador del libro.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truemodificación-del-dto-2"><a class="anchor" href="#truemodificación-del-dto-2"></a>7.2.2. Modificación del DTO</h4>
<div class="paragraph">
<p>En este paso se modifican los DTO afectados. Para el caso de los comentarios habrá que modificar el DTO <code>create-comment.dto.ts</code> para añadirle el identificador de un libro. Este DTO se usará tanto para la creación de nuevos comentarios como para la modificación de comentarios existentes. En cualquier caso, el valor introducido para el libro deberá ser un objeto con el campo <code>id</code> y el identificador del libro. Por tanto, el libro deberá existir previamente antes de crearle un comentario.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>create-comment.dto.ts</code></div>
<div class="content">
<pre>...

export class CreateCommentDto {
  ...

  @ApiProperty({ example: 'johndoe' })
  readonly username: string;

  @ApiProperty({ example: { id: 1 }, type: String }) <i class="conum" data-value="1"></i><b>(1)</b>
  readonly book: Book;
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ejemplo de referencia a un libro</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nuevo campo para el DTO</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Para evitar un error de referencias circulares, añadir <code>type: String</code> en <code>@ApiProperty</code></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación introduciremos un nuevo comentario pasándole como valor de <code>book</code> el libro 1 (<code>{"id": 1}</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "title": "Una maravilla!!",
  "stars": 5,
  "comment": "Alucinante",
  "username": "johndoe",
  "book": {
    "id": 1
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras la inserción vemos que el servidor responde correctamente mostrando el código de estado HTTP de la creación del comentario y devuelvel el comentario creado con el nuevo identificador generado por la base de datos.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/comentario-insertado-con-libro.png" alt="comentario insertado con libro"></span></p>
</div>
<div class="paragraph">
<p>Del mismo modo, podemos modificar el primer comentario para añadirle un libro. Habría que usar el endpoint <code>PATCH /comments/{id}</code> y pasarle como <code>body</code> el objeto del libro al que se quiere asignar. Haríamos la modificación de asignar el comentario ' 1'  al libro <code>1</code>, tal y como indica la figura siguiente.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/asignar-comentario-a-libro.png" alt="asignar comentario a libro"></span></p>
</div>
<div class="paragraph">
<p>Sin embargo, si recuperamos los comentarios con el endpoint <code>GET /comments</code> veremos que aparecen los comentarios, pero sin libro. Del mismo modo, si obtenemos el libro <code>1</code>, al que le hemos creados los comentarios, vemos que los datos aún no aparecen. En la sección siguiente veremos cómo modificar <code>comments.service.ts</code> para que devuelva los datos del libro al recuperar un comentario.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/comentarios-sin-libro.png" alt="comentarios sin libro"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="truemodificación-de-los-servicios-para-que-devuelvan-los-datos-relacionados-2"><a class="anchor" href="#truemodificación-de-los-servicios-para-que-devuelvan-los-datos-relacionados-2"></a>7.2.3. Modificación de los servicios para que devuelvan los datos relacionados.</h4>
<div class="paragraph">
<p>Tal y como comentamos anteriormente, TypeORM permite que a la familia de métodos <code>find</code> se le pase un elemento <code>relations</code> configurando un array de relaciones para indicar las entidades relacionadas que se deberían cargar. En nuestro caso tendremos que hacer modificaciones en:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El servicio de libros para que muestre los comentarios al recuperar los libros.</p>
</li>
<li>
<p>El servicio de comentarios para que se muestre el libro al recuperar un comentario.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Veamos cómo hacerlo.</p>
</div>
<div class="paragraph">
<p>Comenzaremos modificando el servicio de libros para que cargue los comentarios al recuperar un libro. Se trata de incluir la relación <code>comments</code> en los métodos <code>find</code> y <code>findOne</code> de <code>books.service.ts</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>books.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...

@Injectable()
export class BooksService {
  ...

  async findAll(): Promise&lt;Book[]&gt; {
    return this.booksRepository.find({ relations: ['publisher', 'comments'] }); <i class="conum" data-value="1"></i><b>(1)</b>
  }

  async findOne(id: number): Promise&lt;Book&gt; {
    return this.booksRepository.findOne({
      where: { id },
      relations: ['publisher', 'comments'], <i class="conum" data-value="2"></i><b>(2)</b>
    });
  }

  ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Carga de los comentarios relacionados al recuperar los libros</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Carga de los comentarios relacionados al recuperar un libro</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora recuperamos los libros con el endpoint <code>GET /books</code> vemos que ya se incorporan los comentarios a cada libro.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/libros-hidratados-con-comentarios.png" alt="libros hidratados con comentarios"></span></p>
</div>
<div class="paragraph">
<p>A continuación modificamos el servicio de comentarios para que cargue el libro al recuperar un comentario. Se trata de incluir la relación <code>book</code> en los métodos <code>find</code> y <code>findOne</code> de <code>comments.service.ts</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>comments.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...

@Injectable()
export class CommentsService {
  ...

  async findAll(): Promise&lt;Comment[]&gt; {
    return this.commentsRepository.find({ relations: ['book'] }); <i class="conum" data-value="1"></i><b>(1)</b>
  }

  async findOne(id: number): Promise&lt;Comment&gt; {
    return this.commentsRepository.findOne({
      where: { id },
      relations: ['book'], <i class="conum" data-value="2"></i><b>(2)</b>
    });
  }

  ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Carga del libro asociado al recuperar los comentarios</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Carga del libro asociado al recuperar un comentario</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora recuperamos los comentarios con el endpoint <code>GET /comments</code> vemos que ya se incorpora el libro a cada comentario.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/comentario-hidratado-con-libro.png" alt="comentario hidratado con libro"></span></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecreación-de-la-relación-entre-book-y-keyword"><a class="anchor" href="#truecreación-de-la-relación-entre-book-y-keyword"></a>7.3. Creación de la relación entre <code>Book</code> y <code>Keyword</code></h3>
<div class="paragraph">
<p>Entre las entidades <code>Book</code> y <code>Keyword</code> hay una relación <code>M:N</code>. Podemos hacer la relación unidireccional o bidireccional. En este tutorial la haremos bidireccional para que podamos mostrar las palabras clave de un libro así como ver los libros asociados a una palabra clave.</p>
</div>
<div class="sect3">
<h4 id="truemodificación-de-las-entidades-3"><a class="anchor" href="#truemodificación-de-las-entidades-3"></a>7.3.1. Modificación de las entidades</h4>
<div class="paragraph">
<p>Comenzamos añadiendo los cambios a las entidades. Lo haremos en dos pasos:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añadir los campos a cada entidad.</p>
</li>
<li>
<p>Añadir a cada entidad los decoradores de las relaciones.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Tal y como hemos comentado, lo hacemos en dos pasos porque los decoradores usan los nombres de campo del otro extremo de la relación. Por tanto, para no provocar errores durante la creación de las relaciones definiremos primero los campos para poder referenciarlos al crear las relaciones en el segundo paso.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>En relaciones unidireccionales sólo se crea el campo y el decorador de relación en una entidad.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="trueañadir-los-campos-a-cada-entidad-3"><a class="anchor" href="#trueañadir-los-campos-a-cada-entidad-3"></a>Añadir los campos a cada entidad.</h5>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Book</code> para añadir un nuevo campo <code>keywords</code>, cuyo tipo es <code>Keyword[]</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>book.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { Keyword } from '../../keywords/entities/keyword.entity'; <i class="conum" data-value="1"></i><b>(1)</b>

@Entity()
export class Book {
  ...

  @OneToMany(() =&gt; Comment, (comments: Comment) =&gt; comments.book)
  comments: Comment[];

  keywords: Keyword[]; <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación de la entidad <code>Keyword</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creación del campo <code>keywords</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Keyword</code> para añadir un nuevo campo <code>books</code>, cuyo tipo es <code>Book[]</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>keyword.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Entity, PrimaryGeneratedColumn, Column } from 'typeorm';
import { ApiProperty } from '@nestjs/swagger';
import { Book } from '../../books/entities/book.entity'; <i class="conum" data-value="1"></i><b>(1)</b>
@Entity()
export class Keyword {
  @ApiProperty({ example: 99 })
  @PrimaryGeneratedColumn()
  id: number;

  @ApiProperty({ example: 'NestJS' })
  @Column()
  keyword: string;

  books: Book[]; <i class="conum" data-value="2"></i><b>(2)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Importación de la entidad <code>Book</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Creación del campo <code>books</code></td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Por ahora, ninguno de las campos introducidos en las entidades <code>Book</code> y <code>Keyword</code> tienen efecto sobre la base de datos. Esto se debe a que ni han sido decorados con <code>@Column()</code> ni con ninguna relación. Por ahora, son sólo campos de la clase, pero no han pasado a la base de datos.</p>
</div>
</div>
<div class="sect4">
<h5 id="trueañadir-los-decoradores-de-relación-a-cada-entidad-3"><a class="anchor" href="#trueañadir-los-decoradores-de-relación-a-cada-entidad-3"></a>Añadir los decoradores de relación a cada entidad</h5>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Book</code> para añadir la relación <code>M:N</code> con <code>Keyword</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>book.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...
import { Keyword } from '../../keywords/entities/keyword.entity';

@Entity()
export class Book {
  ...

  @OneToMany(() =&gt; Comment, (comments: Comment) =&gt; comments.book)
  comments: Comment[];

  @ManyToMany( <i class="conum" data-value="1"></i><b>(1)</b>
    () =&gt; Keyword, <i class="conum" data-value="2"></i><b>(2)</b>
    (keyword: Keyword) =&gt; keyword.books, <i class="conum" data-value="3"></i><b>(3)</b>
  )
  @JoinTable() <i class="conum" data-value="4"></i><b>(4)</b>
  keywords: Keyword[];
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador para la relación <code>M:N</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definición del tipo (del otro extremo) de la relación</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Definición de la propiedad inversa</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Decorador para indicar nombre de la tabla M:N creada, nombres de columna, &#8230;&#8203;</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para la definición de la propiedad se establece un objeto (<code>keyword</code>) de la entidad del otro extremo y se indica el campo que establece la relación inversa (<code>keyword.books</code>).</p>
</div>
<div class="paragraph">
<p>Al guardar los cambios en la entidad, se habrá creado una nueva tabla en la base de datos, ya que en relaciones <code>M:N</code> se crea una tabla nueva para la relación formada por la unión de las claves de entidades que participan en la relación(<code>Book</code> y <code>Keyword</code>).</p>
</div>
<div class="paragraph">
<p>A continuación se muestran los cambios introducidos en la entidad <code>Keyword</code> para añadir la relación <code>M:N</code> con <code>Book</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>keyword.entity.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">import { Entity, PrimaryGeneratedColumn, Column, ManyToMany } from 'typeorm';
import { ApiProperty } from '@nestjs/swagger';
import { Book } from '../../books/entities/book.entity';
@Entity()
export class Keyword {
  @ApiProperty({ example: 99 })
  @PrimaryGeneratedColumn()
  id: number;

  @ApiProperty({ example: 'NestJS' })
  @Column()
  keyword: string;


  @ManyToMany( <i class="conum" data-value="1"></i><b>(1)</b>
    () =&gt; Book, <i class="conum" data-value="2"></i><b>(2)</b>
    (book: Book) =&gt; book.keywords, <i class="conum" data-value="3"></i><b>(3)</b>
  )
  books: Book[];
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Decorador para la relación <code>M:N</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Definición del tipo (del otro extremo) de la relación</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Definición de la propiedad inversa.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para la definición de la propiedad se establece un objeto (<code>book</code>) de la entidad del otro extremo y se indica el campo que establece la relación inversa (<code>book.keywords</code>).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truemodificación-del-dto-3"><a class="anchor" href="#truemodificación-del-dto-3"></a>7.3.2. Modificación del DTO</h4>
<div class="paragraph">
<p>En este paso se modifican los DTO afectados. Para el caso de las palabras clave habrá que modificar el DTO <code>create-book.dto.ts</code> para añadirle a un libro las palabras clave. Este DTO se usará tanto para la creación de nuevos libros como para la modificación de libros existentes. En cualquier caso, el valor introducido para la palabra clave deberá ser un objeto con el campo <code>id</code> y el identificador de la palabra clave. Por tanto, la palabra clave deberá existir previamente antes de asociarla a un libro.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>create-book.dto.ts</code></div>
<div class="content">
<pre>...

export class CreateBookDto {
  ...

  @ApiProperty({ example: { id: 1 } })
  readonly publisher: Publisher;

  @ApiProperty({ example: [{ id: 1 }, { id: 2 }] }) <i class="conum" data-value="1"></i><b>(1)</b>
  readonly keywords: Keyword[]; <i class="conum" data-value="2"></i><b>(2)</b>
}</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Ejemplo de identificadores de palabras clave de un libro</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Nuevo campo para el DTO</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A continuación introduciremos un nuevo libro pasándole como valor de <code>keyword</code> las dos existentes (<code>[{"id": 1}, {"id": 2}]</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code data-lang="json" class="language-json hljs">{
  "title": "Nest.js: A Progressive Node.js Framework (English Edition)",
  "genre": "Desarrollo web",
  "description": "JavaScript frameworks go in and out of style very quickly as web technologies change and grow. Nest.js is a good starting point for many developers that are looking to use a modern web framework because it uses a language that is very similar to that of the most used language on the web to this day, JavaScript...",
  "author": "Jay Bell",
  "pages": 350,
  "image_url": "www.imagen.com/nestjs.png",
  "publisher": {
    "id": 1
  },
  "keywords": [
    {
      "id": 1
    },
    {
      "id": 2
    }
  ]
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras la inserción vemos que el servidor responde correctamente mostrando el código de estado HTTP de la creación del libro y devuelvel el libro creado con el nuevo identificador generado por la base de datos.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/libro-insertado-con-palabras-clave.png" alt="libro insertado con palabras clave"></span></p>
</div>
<div class="paragraph">
<p>Del mismo modo, podríamos modificar un libro existente para añadirle palabras clave. Habría que usar el endpoint <code>PATCH /books/{id}</code> y pasarle como <code>body</code> el array de objetos palabras clave que se le quieren asignar.</p>
</div>
<div class="paragraph">
<p>Sin embargo, si recuperamos los libros con el endpoint <code>GET /books</code> veremos que aparece el libro, pero sin las palabras clave. Del mismo modo, si obtenemos las palabras clave, vemos que los aparece el libro que tiene esas palabras clave. En la sección siguiente veremos cómo modificar <code>books.service.ts</code> para que devuelva las palabras clave al recuperar un libro.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/libro-sin-palabras-clave.png" alt="libro sin palabras clave"></span></p>
</div>
</div>
<div class="sect3">
<h4 id="truemodificación-de-los-servicios-para-que-devuelvan-los-datos-relacionados-3"><a class="anchor" href="#truemodificación-de-los-servicios-para-que-devuelvan-los-datos-relacionados-3"></a>7.3.3. Modificación de los servicios para que devuelvan los datos relacionados.</h4>
<div class="paragraph">
<p>Tal y como comentamos anteriormente, TypeORM permite que a la familia de métodos <code>find</code> se le pase un elemento <code>relations</code> configurando un array de relaciones para indicar las entidades relacionadas que se deberían cargar. En nuestro caso tendremos que hacer modificaciones en:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>El servicio de libros para que muestre las palabras clave al recuperar los libros.</p>
</li>
<li>
<p>El servicio de palabras clave para que se muestren los libros asociados a una palabra clave.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Veamos cómo hacerlo.</p>
</div>
<div class="paragraph">
<p>Comenzaremos modificando el servicio de libros para que cargue las palabras clave al recuperar un libro. Se trata de incluir la relación <code>keywords</code> en los métodos <code>find</code> y <code>findOne</code> de <code>books.service.ts</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>books.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...

@Injectable()
export class BooksService {
  ...

  async findAll(): Promise&lt;Book[]&gt; {
    return this.booksRepository.find({
      relations: ['publisher', 'comments', 'keywords'], <i class="conum" data-value="1"></i><b>(1)</b>
    });
  }

  async findOne(id: number): Promise&lt;Book&gt; {
    return this.booksRepository.findOne({
      where: { id },
      relations: ['publisher', 'comments', 'keywords'], <i class="conum" data-value="2"></i><b>(2)</b>
    });
  }

  ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Carga de las palabras clave relacionadas al recuperar los libros</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Carga de las palabras clave relacionadas al recuperar un libro</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora recuperamos los libros con el endpoint <code>GET /books</code> vemos que ya se incorporan las palabras clave a cada libro.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/libros-hidratados-con-palabras-clave.png" alt="libros hidratados con palabras clave"></span></p>
</div>
<div class="paragraph">
<p>A continuación modificamos el servicio de palabras clave para que cargue los libros asociados al recuperar una palabra clave. Se trata de incluir la relación <code>books</code> en los métodos <code>find</code> y <code>findOne</code> de <code>keywords.service.ts</code>.</p>
</div>
<div class="listingblock">
<div class="title">Archivo <code>keywords.service.ts</code></div>
<div class="content">
<pre class="highlightjs highlight"><code data-lang="ts" class="language-ts hljs">...

@Injectable()
export class KeywordsService {
  ...

  async findAll(): Promise&lt;Keyword[]&gt; {
    return this.keywordsRepository.find({ relations: ['books'] });
  }

  async findOne(id: number): Promise&lt;Keyword&gt; {
    return this.keywordsRepository.findOne({
      where: { id },
      relations: ['books'],
    });
  }

  ...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Carga de los libros asociados al recuperar las palabras clave</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Carga de los libros asociados al recuperar una palabra clave</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Si ahora recuperamos las palabras clave con el endpoint <code>GET /keywords</code> vemos que ya se incorporan la lista de libros asociadas a cada palabra clave.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="./images/palabras-clave-hidratadas-con-libros.png" alt="palabras clave hidratadas con libros"></span></p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-04-13 17:46:27 +0200
</div>
</div>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/github.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script>hljs.initHighlighting()</script>
</body>
</html>